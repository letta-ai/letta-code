name: AI Issue Handler (Enhanced)

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened, labeled]

jobs:
  handle-letta-command:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/letta')) ||
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'letta'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract command and mentions
        id: extract
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            let body, command;
            
            if (context.eventName === 'issue_comment') {
              body = context.payload.comment.body;
              command = body.replace(/^.*\/letta\s+/, '');
            } else {
              body = context.payload.issue.body || '';
              command = body;
            }
            
            // Extract @mentions
            const mentionRegex = /@([a-zA-Z0-9-]+)/g;
            const mentions = [...body.matchAll(mentionRegex)].map(m => m[1]);
            const uniqueMentions = [...new Set(mentions)].filter(m => m !== context.actor);
            
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            core.setOutput('command', command);
            core.setOutput('mentions', uniqueMentions.join(','));
            core.setOutput('issue_author', issue.data.user.login);

      - name: React to comment
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Run Letta Code
        id: letta
        uses: letta-ai/letta-code@v1
        with:
          api-key: ${{ secrets.LETTA_API_KEY }}
          prompt: |
            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}
            Issue author: @${{ steps.extract.outputs.issue_author }}
            Mentioned users: ${{ steps.extract.outputs.mentions }}
            
            Issue body:
            ${{ github.event.issue.body }}
            
            User command: ${{ steps.extract.outputs.command }}
            
            Please complete the requested task.
          cli-args: >-
            --model claude-sonnet-4.5
            --tools Bash,Read,Write,Edit,Grep,Glob
            --permission-mode acceptEdits
            --output-format json

      - name: Create PR with changes
        if: steps.letta.outputs.exit-code == '0'
        id: create-pr
        run: |
          git config user.name "Letta Code"
          git config user.email "noreply@letta.com"
          
          if [[ -n $(git status -s) ]]; then
            BRANCH_NAME="letta-issue-${{ github.event.issue.number }}-$(date +%s)"
            git checkout -b $BRANCH_NAME
            git add .
            git commit -m "ü§ñ Fix for issue #${{ github.event.issue.number }}

          ${{ steps.extract.outputs.command }}

          Closes #${{ github.event.issue.number }}"
            
            git push origin $BRANCH_NAME
            
            PR_URL=$(gh pr create \
              --title "ü§ñ Fix for #${{ github.event.issue.number }}: ${{ github.event.issue.title }}" \
              --body "Fixes #${{ github.event.issue.number }}

          cc: @${{ steps.extract.outputs.issue_author }} ${{ steps.extract.outputs.mentions && format('@{0}', steps.extract.outputs.mentions) }}")
            
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on issue
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const exitCode = '${{ steps.letta.outputs.exit-code }}';
            const result = `${{ steps.letta.outputs.result }}`;
            const hasChanges = '${{ steps.create-pr.outputs.has_changes }}';
            const prUrl = '${{ steps.create-pr.outputs.pr_url }}';
            const mentions = '${{ steps.extract.outputs.mentions }}'.split(',').filter(m => m);
            const author = '${{ steps.extract.outputs.issue_author }}';
            
            let body = `@${author}`;
            if (mentions.length > 0) {
              body += ' ' + mentions.map(m => `@${m}`).join(' ');
            }
            body += '\n\n## ü§ñ Letta Code Results\n\n';
            
            if (exitCode === '0') {
              body += `‚úÖ Task completed!\n\n${result}\n\n`;
              if (hasChanges === 'true' && prUrl) {
                body += `**Pull Request:** ${prUrl}\n\n`;
              }
            } else {
              body += `‚ùå Task failed (exit code: ${exitCode})\n`;
            }
            
            body += '\n---\n*Powered by [Letta Code](https://github.com/letta-ai/letta-code)*';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
